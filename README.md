PWQ 是一款轮状队列，可以将排队数据持久化到硬盘。

# 现有系统遇到的问题？

## 业务场景

“在一段时间之后，自动完成一个工作任务”。例如：订单完成后，用户一直不评价，那么在 48 小时后会自动给予订单 5 星好评。

## 常规实现方案

使用 `crontab` 定时脚本，每分钟从订单表中查出完成时间大于48小时，且没有评价的订单，将评价更新为 5 星。

优点：代码结构简单，便于理解。

缺点：数据量大的时候，每次扫表查询使用的多条件的二级索引，效率不高；查询出订单数据后不一定能够在一分钟内处理完待评价的订单。

# 什么是轮状队列？

轮状队列实际上是一个长度为 60 的数组（下文称为插槽）。每个任务包含自己的唯一key、执行时间以及执行的额外参数。创建任务的时候，将任务放入其执行时间对应分钟数的插槽内。由另外的定时脚本没分组读取当前时间分钟数对应的插槽需要执行的任务，并另启协程执行。

# 轮状队列的缺点？

1. 当大量未到执行时间的任务在队列里堆积的时候，会占用大量内存，造成OOM。
2. 服务重启后排队的任务会丢失。

# 持久化有什么用？

1. 堆积在队列中的任务会定时写入硬盘，不会对内存造成压力。 
2. 服务正常重启时，内存中的任务会写入硬盘后，再停服启动。 
3. 服务异常重启时，只有内存中的任务会丢失，硬盘中的任务会在约定的时间继续执行。
